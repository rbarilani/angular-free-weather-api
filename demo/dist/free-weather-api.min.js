/**
 * angular-free-weather-api
 * @version v0.0.1beta - 2014-04-22
 * @link https://github.com/hal9087/free-weather-api
 * @author Ruben Barilani <ruben.barilani.dev@gmail.com>
 * @license MIT License, http://www.opensource.org/licenses/MIT
 */

"use strict";angular.module("hal9087.freeWeatherApi",[]).constant("FREE_WEATHER_API_DEFAULT_PARAMETERS",{version:"v1",premium:!1,url:"http://api.worldweatheronline.com",method:"jsonp",endPoints:{localWeather:"/weather.ashx",skyAndMountainWeather:"/sky.ashx",marineWeather:"/marine.ashx",timezone:"/tz.ashx",search:"/search.ashx",pastWeather:"/past-weather.ashx"},params:{includelocation:"yes"}}).provider("freeWeatherApi",["FREE_WEATHER_API_DEFAULT_PARAMETERS",function(a){var b,c=this,d=a,e=d,f={url:function(a){return e.url+"/"+(e.premium?"premium":"free")+"/"+e.version+a},config:function(a,b,d){var f,g=b||{},h=angular.copy(e.params);return g.format="json","jsonp"===e.method&&(g.callback="JSON_CALLBACK"),f=angular.extend({key:c.getApiKey(),q:a},angular.extend(h,g)),angular.extend({params:f},d||{})}};return c.setParameters=function(a){return e=angular.extend(d,a),c},c.setApiKey=function(a){return b=a,c},c.getApiKey=function(){return b},c.$get=["$q","$http","$rootScope",function(a,b){function d(c){return function(d,g,h){var i=f.config(d,g,h),j=a.defer(),k=j.promise,l=e.method,m="search_api";return k.$data={},b[l](c,i).then(function(a){var b;return a.data&&a.data.data&&a.data.data.error?(a.status=400,void j.reject({error:angular.copy(a.data.data.error),originalResponse:a})):(b=angular.copy(a.data.data?a.data.data:a.data[m]&&a.data[m].result?a.data[m].result:a.data),angular.extend(k.$data,b),void j.resolve({data:b,originalResponse:a}))}).catch(function(a){j.reject({error:[{msg:"Unknown error! "}],originalResponse:a})}),k}}if(!angular.isString(c.getApiKey()))throw new Error("You must provide a valid Free Weather Api Key, actual is : "+c.getApiKey());var g=e.endPoints,h={localWeather:f.url(g.localWeather),skyAndMountainWeather:f.url(g.skyAndMountainWeather),marineWeather:f.url(g.marineWeather),timezone:f.url(g.timezone),search:f.url(g.search),pastWeather:f.url(g.pastWeather)},i={};return i.localWeather=function(){},i.skyAndMountainWeather=function(){},i.marineWeather=function(){},i.timezone=function(){},i.search=function(){},i.pastWeather=function(){},angular.forEach(h,function(a,b){i[b]=d(a)}),i.getApiKey=function(){return c.getApiKey()},i}],c}]);